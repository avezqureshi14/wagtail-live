(()=>{"use strict";function e(e,t,n){e.addEventListener("click",(()=>{t.click()})),t.addEventListener("change",(()=>{const e=t.files.length;n.innerHTML=`${e} image${e>1?"s":""} uploaded.`}))}const t=[];function n(e,s=1){if(document.getElementById("current-alert"))return void t.push([e,s]);const i=document.createElement("div");i.id="current-alert",i.classList.add("alert","fixed-top"),i.style.transition="all 1s ease 0s",i.setAttribute("role","alert"),i.innerText=e,i.style.opacity=0,i.style.height=0,document.body.insertAdjacentElement("afterbegin",i),1==s?i.classList.add("alert-success"):i.classList.add("alert-danger"),i.style.height="auto",i.style.opacity="1",setTimeout((()=>{i.style.height=0,i.style.opacity=0,i.remove(),t.length&&n(...t.shift())}),1500)}async function s(e,t,s,i=200,a=!0){const o=document.querySelector("[name=csrfmiddlewaretoken]").value;if(!o)throw new Error("No CSRF Token found.");const l={"X-CSRFToken":o};a&&(l["Content-Type"]="application/json");const c=`/webapp/api/${e}`,r=await fetch(c,{method:t,headers:l,body:s});if(r.status!=i){const e=await r.json();return n(Object.values(e)[0],0),{ok:!1}}return{ok:!0,response:r}}function i(e){const t=document.createElement("li");return t.classList.add("list-group-item","mb-5","p-0"),t.style.border="none",t.innerHTML=e,t}class a{constructor(e,t,n){this.post=e,this.channelName=t,this.wrapper=n,this.pk=this.post.dataset.id,void 0===this.pk&&(this.pk=this.post.firstElementChild.dataset.id),this.editButton=this.post.querySelector(".show-edit-form"),this.deleteButton=this.post.querySelector(".delete-message")}bindEvents(){this.editButton.addEventListener("click",this.showEditForm.bind(this)),this.deleteButton.addEventListener("click",this.delete.bind(this)),this.fullyBound=!1}_bind(){this.fullyBound||(this.content=this.post.querySelector(".message-body"),this.editForm=this.post.querySelector(".edit-form"),this.editForm.addEventListener("submit",this.edit.bind(this)),this.cancelEditButton=this.post.querySelector(".cancel-edit"),this.cancelEditButton.addEventListener("click",this.cancelEdit.bind(this)),this.uploadImageButton=this.post.querySelector(".upload-btn"),this.uploadImageSelect=this.post.querySelector(".upload-file"),this.uploadCountDiv=this.post.querySelector(".upload-count"),e(this.uploadImageButton,this.uploadImageSelect,this.uploadCountDiv),this.deleteImageButtons=this.post.querySelectorAll(".delete-image"),this.deleteImageButtons.forEach((e=>{e.addEventListener("click",this.deleteImage.bind(this))})),this.fullyBound=!0)}showEditForm(){this._bind(),this.editButton.style.display="none",this.content.style.display="none",this.editForm.style.display=""}replace(e){const t=i(e);this.wrapper.replaceChild(t,this.post),this.post=t,this.deleteButton=this.post.querySelector(".delete-message"),this.editButton=this.post.querySelector(".show-edit-form"),this.bindEvents()}cancelEdit(){this.editForm.style.display="none",this.content.style.display="",this.editButton.style.display=""}async edit(e){e.preventDefault();const t=new FormData(this.editForm);t.append("channel",this.channelName);try{let e=await s(`messages/${this.pk}/`,"PUT",t,200,!1);if(!e.ok)return;n(`Message ${this.pk} edited.`);const i=await e.response.text();this.replace(i)}catch(e){n(e,0)}}async delete(){try{if(!(await s(`messages/${this.pk}/`,"DELETE",{},204)).ok)return;this.post.remove(),n(`Message ${this.pk} deleted.`)}catch(e){n(e,0)}}getImage(e){return this.post.querySelector(`li[data-id='${e}']`)}async deleteImage(e){e.preventDefault();const t=e.currentTarget.dataset.id;try{if(!(await s(`images/${t}/`,"DELETE",{},204)).ok)return;const e=this.getImage(t);e&&e.remove(),n(`Image ${t} deleted.`)}catch(e){n(e,0)}}}async function o(e){e.preventDefault();const t=e.target.channel_name.value;if(!t.match(/^[a-zA-Z0-9-_]+$/))return n("Channel names can only contain alphanumeric characters or - and _",0),void(document.querySelector("#channel_name").value="");try{const e=JSON.stringify({channel_name:t}),i=await s("channels/","POST",e,201);if(!i.ok)return void(document.querySelector("#channel_name").value="");const a=await i.response.json();n(`Channel ${a.channel_name} created.`);const o=function(e){const t=e.channel_name,n=function(e){return`${window.location.protocol}//${window.location.host}/webapp/channels/${e}/`}(t),s=document.createElement("div");return s.classList.add("d-flex"),s.dataset.id=t,s.innerHTML=`\n        <li class="list-group-item list-group-item-action">\n            <a href="${n}" class="text-decoration-none">\n                <div class="d-flex flex-wrap my-1 justify-content-between">\n                    <h5 class="mb-1">#${t}</h5>\n                    <small class="text-muted">Created now</small>\n                </div>\n                <small class="text-muted">${e.posts_count} posts</small>\n            </a>\n        </li>\n        <button type="button" class="btn col-2 delete-btn opacity-50" data-channel="${t}">\n            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#B83030"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>\n        </button>\n    `,s.querySelector(".delete-btn").addEventListener("click",l),s}(a);document.querySelector("ul").insertAdjacentElement("afterbegin",o),document.querySelector("#channel_name").value=""}catch(e){n(e,0)}}async function l(e){e.preventDefault();const t=e.currentTarget,{channel:i}=t.dataset;try{(await s(`channels/${i}/`,"DELETE",{},204)).ok&&(n(`Channel ${i} deleted.`),document.querySelector(`[data-id=${i}]`).remove())}catch(e){return n(e,0),e}}document.addEventListener("DOMContentLoaded",(()=>{const t=document.querySelector("#new-message-form"),o=document.getElementById("live-posts");if(!t||!o)return;const l=o.dataset.channel;t.addEventListener("submit",(e=>{!async function(e,t,o){e.preventDefault();const l=e.target,c=new FormData(l);c.append("channel",t);try{let e=await s("messages/","POST",c,201,!1);if(!e.ok)return;document.querySelector("#content").value="",document.querySelector("#images").value="",document.querySelector("#imagesList").innerHTML="",n("Message posted.");const l=i(await e.response.text());o.prepend(l),new a(l,t,o).bindEvents()}catch(e){n(e,0)}}(e,l,o)})),e(document.getElementById("uploadFile"),document.getElementById("images"),document.getElementById("imagesList")),Array.from(o.children).forEach((e=>{new a(e,l,o).bindEvents()}))})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("#new-channel-form");e&&(e.addEventListener("submit",o),document.querySelectorAll(".delete-btn").forEach((e=>{e.addEventListener("click",l)})))}))})();
//# sourceMappingURL=main.js.map